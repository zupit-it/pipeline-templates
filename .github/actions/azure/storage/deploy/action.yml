#IMPORTANT: THIS ACTION MUST BE EXECUTED ON A CLEAN ENVIRONMENT WITH AZ INSTALLED

name: Deploy app to Azure Storage

inputs:
  WORKING_DIRECTORY:
    required: true
    type: string
  BINARIES_DIRECTORY:
    required: true
    type: string
  AZURE_CREDENTIALS:
    required: true
    type: string
  STORAGE_ACCOUNT_NAME:
    required: true
    type: string
  CDN_PROFILE_NAME:
    required: false
    type: string
    default: ""
  CDN_ENDPOINT_NAME:
    required: false
    type: string
    default: ""
  CDN_RG_NAME:
    required: false
    type: string
    default: ""
  FD_RG_NAME:
    required: false
    type: string
    default: ""
  FD_ENDPOINT_NAME:
    required: false
    type: string
    default: ""
  FD_DOMAIN_NAME:
    required: false
    type: string
    default: ""
  FD_PROFILE_NAME:
    required: false
    type: string
    default: ""

runs:
  using: composite
  steps:
    - name: Azure login
      uses: azure/login@v1
      with:
        creds: ${{ inputs.AZURE_CREDENTIALS }}

    - name: Install azcopy
      shell: bash
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/azcopy
        cd ${GITHUB_WORKSPACE}/azcopy
        wget https://azcopyvnext-awgzd8g7aagqhzhe.b02.azurefd.net/release20211027/azcopy_linux_amd64_10.13.0.tar.gz
        tar -xzf azcopy_linux_amd64_10.13.0.tar.gz --strip-components=1
        chmod +x azcopy
        echo "${GITHUB_WORKSPACE}/azcopy" >> $GITHUB_PATH
        mkdir -p ${RUNNER_TEMP}/bin
        ln -sf ${GITHUB_WORKSPACE}/azcopy/azcopy ${RUNNER_TEMP}/bin/azcopy
        echo "${RUNNER_TEMP}/bin" >> $GITHUB_PATH
        rm azcopy_linux_amd64_10.13.0.tar.gz
        ${RUNNER_TEMP}/bin/azcopy --version

    - name: Deploy to Azure Storage
      shell: bash
      run: |
        # Calculate 30 minutes from now in seconds since epoch
        FUTURE_EPOCH=$(($(date +%s) + 1800))
        # Convert to desired format using BusyBox date
        END_DATE=$(date -u -d @${FUTURE_EPOCH} '+%Y-%m-%dT%H:%MZ')

        SAS_TOKEN=$(az storage container generate-sas \
          --account-name ${{ inputs.STORAGE_ACCOUNT_NAME }} \
          --name '$web' \
          --permissions acdlrw \
          --expiry $END_DATE \
          -o tsv)

        ${RUNNER_TEMP}/bin/azcopy sync "${{ inputs.WORKING_DIRECTORY }}/${{ inputs.BINARIES_DIRECTORY }}" "https://${{ inputs.STORAGE_ACCOUNT_NAME }}.blob.core.windows.net/\$web?$SAS_TOKEN"

    - name: Purge CDN endpoint
      shell: bash
      if: ${{ inputs.CDN_RG_NAME != '' }}
      run: |
        az cdn endpoint purge --content-paths "/*" --profile-name "${{ inputs.CDN_PROFILE_NAME }}" --name "${{ inputs.CDN_ENDPOINT_NAME }}" --resource-group "${{ inputs.CDN_RG_NAME }}"

    - name: Purge Azure Front Door endpoint
      shell: "bash"
      if: ${{ inputs.FD_RG_NAME != '' }}
      run: |
        az afd endpoint purge --content-paths  "/*" --endpoint-name "${{ inputs.FD_ENDPOINT_NAME }}" --resource-group "${{ inputs.FD_RG_NAME }}" --domains "${{ inputs.FD_DOMAIN_NAME }}" --profile-name "${{ inputs.FD_PROFILE_NAME }}"

    - name: Azure logout
      shell: "bash"
      if: always()
      continue-on-error: true
      run: |
        az logout
        az cache purge
        az account clear
